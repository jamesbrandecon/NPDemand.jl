<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementation Details · NPDemand</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">NPDemand</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">NPDemand.jl</a></li><li class="is-active"><a class="tocitem" href>Implementation Details</a><ul class="internal"><li><a class="tocitem" href="#The-Nonparametric-Demand-Estimation-Problem"><span>The Nonparametric Demand Estimation Problem</span></a></li><li><a class="tocitem" href="#Estimation"><span>Estimation</span></a></li><li><a class="tocitem" href="#Constraints"><span>Constraints</span></a></li><li><a class="tocitem" href="#Fixed-Effects"><span>Fixed Effects</span></a></li></ul></li><li><a class="tocitem" href="../usage/">Usage</a></li><li><a class="tocitem" href="../postestimation/">Post-Estimation</a></li><li><a class="tocitem" href="../functions/">Function Documentation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Implementation Details</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementation Details</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/jamesbrandecon/NPDemand.jl/blob/master/docs/src/details.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementation-Details"><a class="docs-heading-anchor" href="#Implementation-Details">Implementation Details</a><a id="Implementation-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-Details" title="Permalink"></a></h1><p>This page explains both the underlying economic model that our package assumes and some of the details concerning our approach, which implements a nonparametric estimator as in <a href="https://drive.google.com/file/d/1GTDJ7W9Fu0mugQsm14125jYJkPbTvGFh/view?pli=1">Compiani, 2022</a> with a more general suite of (linear and nonlinear) constraints and implementation/estimation options. </p><h2 id="The-Nonparametric-Demand-Estimation-Problem"><a class="docs-heading-anchor" href="#The-Nonparametric-Demand-Estimation-Problem">The Nonparametric Demand Estimation Problem</a><a id="The-Nonparametric-Demand-Estimation-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#The-Nonparametric-Demand-Estimation-Problem" title="Permalink"></a></h2><p>Our package estimates a demand function for <span>$J$</span> goods, allowing flexible substitution patterns including some forms of complementarities. Letting <span>$s$</span> denote market shares, the assumed demand function takes the following form: </p><p class="math-container">\[    s_{jt} = \sigma_j(\delta_{jt})\]</p><p>where <span>$j,t$</span> index products and markets respectively. Note that <span>$\sigma$</span> is indexed by <span>$j$</span>, allowing the demand functions of different goods to take different forms. The arguments of <span>$\sigma$</span> are <span>$\delta$</span>, which we assume takes the following form: </p><p class="math-container">\[    \delta_{jt} = \beta x_{jt} + \xi_{jt}\]</p><p>where <span>$x_{jt}$</span> denote observable product characteristics including price, and <span>$\xi_{jt}$</span> denotes unobservable demand shifters at the product-market level. Direct estimation of <span>$\sigma$</span> would be complicated here due to the fact that <span>$\xi$</span> enters <span>$\sigma$</span> nonlinearly. Instead, under conditions stated in <a href="https://drive.google.com/file/d/1GTDJ7W9Fu0mugQsm14125jYJkPbTvGFh/view?pli=1">Compiani, 2022</a>, we can <strong>invert</strong> <span>$\sigma$</span> and estiamte the resulting inverse. The inverse demand equation is then: </p><p class="math-container">\[    x_{jt} = \sigma^{-1}_{j}(s_{jt}) - \xi_{jt}\]</p><p>The <strong>inverse</strong> demand functions can then be estimated via Nonparametric Instrumental Variables (NPIV). We discuss the exact implementation below. </p><h2 id="Estimation"><a class="docs-heading-anchor" href="#Estimation">Estimation</a><a id="Estimation-1"></a><a class="docs-heading-anchor-permalink" href="#Estimation" title="Permalink"></a></h2><p>The estimation problem takes the following form: </p><p class="math-container">\[    \min_{\theta} \sum_{j=1}^J \Big [\sum_{t=1}^T \tilde \xi_{jt} \Big ]&#39;(A_j&#39;A_j)^- \Big [\sum_{t=1}^T \tilde \xi_{jt} \Big ]\]</p><p>where <span>$\tilde \xi_{jt}$</span> are the values of <span>$\xi_{jt}$</span> implies by the current estimate of the demand system. The matrix <span>$A_j$</span> is a matrix of demand instruments for product <span>$j$</span>.</p><p>In practice, we found this problem to be difficult to efficiently solve as written. Instead, during the process of problem construction, we reformulate the problem by multiplying out the product of matrices above. In particular, for appropriately defined values of <span>$y,X$</span> and <span>$Z$</span>, we can rewrite the objective function as </p><p class="math-container">\[    \min_\theta (y - X\theta)&#39; Z (y - X \theta)\]</p><p>For complicated problems, <span>$\theta$</span> can include hundreds of parameters, meaning that <span>$Z$</span> and <span>$X$</span> may have hundreds of columns (and, in the case of <span>$Z$</span>, rows). Manipulating  these large matrices directly resulted in an estimation process that was quite slow even with analytic gradients. However, note that if we multiply out the product above, we get </p><p class="math-container">\[    y&#39;Zy + y&#39;Z X\theta - \theta&#39;X&#39;Zy + \theta&#39;X&#39;X \theta \]</p><p>Note, then, that the first term is constant with respect to <span>$\theta$</span>, and the rest of the terms are relatively small matrices which can be pre-computed prior to estimation.  In practice, to handle normalizations and to treat the components <span>$\theta$</span> that correspond to the index <span>$\delta$</span> differently from those that correspond to the inverse demand functions themselves,  we use a slightly different formulation, but the impact is the same. By pre-computing these matrices and storing them during problem construction, we find that estimation is dramatically faster.  The only cost we pay is that this process introduces a small amount of (floating-point) errors in our objective function construction, but we find that these are negligible even in simulated data with unreasonably high signal to noise ratios (i.e., small optimized objective values). If users report that these errors appear non-negligible in practice, we may update the package with an option to solve the problem in the standard way. </p><p>Although in many cases the economic constraints of interest are linear, the package allows for nonlinear constraints as well. In order to incorporate both constraints, we  rely on a generic unconstrained optimizer (LBFGS in Optim.jl) to solve the problem, where constraints are imposed as a penalty term in the objective function. In any problem with  exchangeability imposed, we first solve the problem under exchangeability alone (no other constraints). We then use the solution to the unconstrained problem as a starting point, and re-solve  the problem with all constraints included in penalty terms. We solve this constrained problem repeatedly, increasing the magnitude of the penalty parameter each time, until either the constraints  are satisfied or the number of iterations surpasses the value of <code>max_outer_iterations</code> provided in the problem definition. </p><h2 id="Constraints"><a class="docs-heading-anchor" href="#Constraints">Constraints</a><a id="Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Constraints" title="Permalink"></a></h2><p>One of the goals of our package was to build a structure that would allow for both linear and nonlinear constraints to be incorporated into nonparametric demand estimation. As a result, we do not rely on CVX (Convex.jl) or other linear solvers to solve our problem, even though with the appropriate constraints the problem we solve is well-behaved. Instead, for linear constraints, we solve the problem via LBFGS with analytic gradients (for both the objective function and gradients), and for nonlinear constraints we use Julia&#39;s autodiff capabilities </p><ol><li>Solve the unconstrained problem  a. Note: the <code>:exchangeability</code> constraint is imposed in the construction of the <code>NPDProblem</code>, so the &quot;unconstrained&quot; step when <code>:exchangeability</code> is specified  </li><li>Re-solve the problem with a penalty term which is quadratic in the distance to the constrained feasible space </li><li>Repeat (2), increasing the magnitude of the penalty term, until the constraints are satisfied. </li></ol><h2 id="Fixed-Effects"><a class="docs-heading-anchor" href="#Fixed-Effects">Fixed Effects</a><a id="Fixed-Effects-1"></a><a class="docs-heading-anchor-permalink" href="#Fixed-Effects" title="Permalink"></a></h2><p>Fixed effects are estimated as parameters, not absorbed from the data. So, be careful including fixed effects with too many values, as this may both slow down the optimization and require more memory.</p><p>To include fixed effects (categorical variables), use the option <code>FE</code> to provide a vector of strings, where each element of the vector is a name of a column in the provided data <code>df</code>. Note however that at present, variables that are included as fixed effect must be constant across products within a market. The only exception to this rule is <code>&quot;product&quot;</code> which is a keyword which will produce product fixed-effects. There need not be a column named <code>product</code> in the data, and in fact the code will ignore it if it&#39;s there. </p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Given how commmon fixed effect regression packages have become, users may expect the package to smartly identify and drop singletons and perform colinearity checks. This it not yet implemented– at present, the only thing we do beyond including all fixed effects as dummy variables is to drop one level per dimension of fixed effects. </p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« NPDemand.jl</a><a class="docs-footer-nextpage" href="../usage/">Usage »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Friday 1 September 2023 16:46">Friday 1 September 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
